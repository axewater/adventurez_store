{% extends 'base.html' %}

{% block title %}Statistics - Text Adventure Builder Store{% endblock %}

{% block extra_css %}
<style>
    .admin-container {
        display: flex;
    }
    
    .admin-sidebar {
        width: 250px;
        min-height: calc(100vh - 200px);
    }
    
    .admin-content {
        flex: 1;
        padding-left: 30px;
    }
    
    @media (max-width: 992px) {
        .admin-container {
            flex-direction: column;
        }
        
        .admin-sidebar {
            width: 100%;
            min-height: auto;
            margin-bottom: 30px;
        }
        
        .admin-content {
            padding-left: 0;
        }
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<section class="mt-4 fade-in" id="stats-page">
    <h1 class="mb-4">Statistics</h1>
    
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="glass-panel">
                <h5 class="mb-3">Admin Menu</h5>
                <ul class="list-group">
                    <a href="{{ url_for('admin.admin_panel') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                    <a href="{{ url_for('admin.admin_users') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-users me-2"></i>User Management
                    </a>
                    <a href="{{ url_for('admin.admin_manage_adventures') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-book-open me-2"></i>Manage Adventures
                    </a>
                    <a href="{{ url_for('admin.admin_api_keys') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-key me-2"></i>API Keys
                    </a>
                    <a href="{{ url_for('admin.admin_stats') }}" class="list-group-item list-group-item-action active">
                        <i class="fas fa-chart-bar me-2"></i>Statistics
                    </a>
                    <a href="{{ url_for('admin.admin_settings') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-cog me-2"></i>Settings
                    </a>
                    <a href="{{ url_for('moderate.moderate_list') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-tasks me-2"></i>Moderation
                        {% if pending_moderation_count > 0 %}
                            <span class="badge bg-danger float-end">{{ pending_moderation_count }}</span>
                        {% endif %}
                    </a>
                </ul>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="admin-content">
            <div class="glass-panel">
                <h3 class="mb-4">Site Statistics</h3>
                
                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="glass-panel text-center">
                            <i class="fas fa-users fa-2x mb-2 text-primary"></i>
                            <h5>Total Users</h5>
                            <h3>{{ total_users }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="glass-panel text-center">
                            <i class="fas fa-book fa-2x mb-2 text-primary"></i>
                            <h5>Adventures</h5>
                            <h3>{{ total_adventures }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="glass-panel text-center">
                            <i class="fas fa-hourglass-half fa-2x mb-2 text-warning"></i>
                            <h5>Pending</h5>
                            <h3>{{ pending_adventures }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="glass-panel text-center">
                            <i class="fas fa-download fa-2x mb-2 text-success"></i>
                            <h5>Downloads</h5>
                            <h3>{{ total_downloads }}</h3>
                        </div>
                    </div>
                </div>
                
                <!-- User Roles Chart -->
                <div class="glass-panel mb-4">
                    <h4 class="mb-3">User Roles Distribution</h4>
                    <div class="chart-container">
                        <canvas id="user-roles-chart"></canvas>
                    </div>
                    <script id="user-roles-data" type="application/json">
                        {
                            "labels": [{% for role in user_roles %}"{{ role.role }}"{% if not loop.last %}, {% endif %}{% endfor %}],
                            "data": [{% for role in user_roles %}{{ role.count }}{% if not loop.last %}, {% endif %}{% endfor %}]
                        }
                    </script>
                </div>
                
                <!-- Tag Usage Chart -->
                <div class="glass-panel mb-4">
                    <h4 class="mb-3">Popular Tags</h4>
                    <div class="chart-container">
                        <canvas id="tag-usage-chart"></canvas>
                    </div>
                    <script id="tag-usage-data" type="application/json">
                        {
                            "labels": [{% for tag in tag_usage %}"{{ tag.name }}"{% if not loop.last %}, {% endif %}{% endfor %}],
                            "data": [{% for tag in tag_usage %}{{ tag.count }}{% if not loop.last %}, {% endif %}{% endfor %}]
                        }
                    </script>
                </div>
                
                <!-- Daily Stats Chart -->
                <div class="glass-panel mb-4">
                    <h4 class="mb-3">Activity Over Time (Last 30 Days)</h4>
                    <div class="chart-container">
                        <canvas id="daily-stats-chart"></canvas>
                    </div>
                    <script id="daily-stats-data" type="application/json">
                        {{ daily_stats|tojson }}
                    </script>
                </div>
                
                <!-- API Usage Chart -->
                <div class="glass-panel mt-4">
                    <h4 class="mb-3">API Usage Over Time (Last 30 Days)</h4>
                    <div class="chart-container">
                        <canvas id="api-usage-chart"></canvas>
                    </div>
                    <!-- Data will be fetched and processed by JavaScript -->
                    <script id="api-usage-data" type="application/json">
                        {{ api_usage|tojson }}
                    </script>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
